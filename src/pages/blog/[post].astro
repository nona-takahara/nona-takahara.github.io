---
import gitlog from "gitlog";
import BaseLayout from "@layouts/BaseLayout.astro";
import DisqusArea from "@layouts/DisqusArea.astro";
//@ts-ignore
import path from "node:path";
import { Intl, Temporal } from "@js-temporal/polyfill";
import ignoreHashes from "src/data/blog/ignore-hashes";
import { MdxComponents } from "@data/components/layout/MdxComponents";
import { getCollection, render } from "astro:content";
import { Section } from "@data/components/primitive/Section";
import { Breadcrumb } from "@data/components/layout/Breadcrumb";
import { Text } from "@data/components/ui";
import { Time } from "@data/components/primitive/Time";
import { ArticleHeading } from "@data/components/sections/ArticleHeading";
import { BlogPostNavigation } from "@data/components/sections/BlogPostNavigation";

export async function getStaticPaths() {
  const data = await getCollection("blog");

  return data.map((post) => {
    return {
      params: { post: post.id },
      props: post,
    };
  });
}

async function findFirstAndLatestTimeStamp(fileName: string) {
  const parsedPath = path.parse(fileName);

  const res = await gitlog({
    repo: "./",
    follow: true,
    file: path.format({
      ext: parsedPath.ext,
      dir: parsedPath.dir,
      name: parsedPath.name || parsedPath.base,
    }),
    all: true,
  });

  let first: Temporal.Instant | undefined = undefined,
    latest: Temporal.Instant | undefined = undefined;

  if (res) {
    res.forEach((k) => {
      if (!ignoreHashes.includes(k.hash)) {
        let tp = Temporal.Instant.from(gitlogLibDateToISODate(k.authorDate));
        if (first == undefined || Temporal.Instant.compare(tp, first) === -1) {
          first = tp;
        }
        if (latest == undefined || Temporal.Instant.compare(tp, latest) === 1) {
          latest = tp;
        }
      }
    });
  }

  return { first_commit: first, latest_commit: latest };
}

function gitlogLibDateToISODate(gitlibdate: string) {
  return (
    gitlibdate.slice(0, 10) +
    "T" +
    gitlibdate.slice(11, 19) +
    gitlibdate.slice(20, 23) +
    ":" +
    gitlibdate.slice(23, 25)
  );
}

const formatOptions: Intl.DateTimeFormatOptions = {
  timeZone: "Asia/Tokyo",
  dateStyle: "long",
  timeStyle: "medium",
};

function instantToPlainDate(date: Temporal.Instant | undefined) {
  return date?.toZonedDateTimeISO("Asia/Tokyo").toPlainDate();
}

function getBlogOrder(id: string) {
  const value = Number(id.replace("entry", ""));
  return Number.isFinite(value) ? value : -1;
}

const content = Astro.props;
const filepath = content.filePath || "src/data/blog/" + content.id + ".md";
const date = await findFirstAndLatestTimeStamp(filepath);
const postDate = instantToPlainDate(date.first_commit);
const updateDate = instantToPlainDate(date.latest_commit);
const posts = (await getCollection("blog")).sort(
  (a, b) => getBlogOrder(b.id) - getBlogOrder(a.id),
);
const currentIndex = posts.findIndex((post) => post.id === content.id);
const prevPost = currentIndex > 0 ? posts[currentIndex - 1] : undefined;
const nextPost =
  currentIndex >= 0 && currentIndex < posts.length - 1
    ? posts[currentIndex + 1]
    : undefined;
const prevPostLink = prevPost
  ? { id: prevPost.id, title: prevPost.data.title }
  : undefined;
const nextPostLink = nextPost
  ? { id: nextPost.id, title: nextPost.data.title }
  : undefined;
const useDisqus = !filepath.includes("stock");
const { Content } = await render(content);
---

<BaseLayout
  katex={!!content.data.katex}
  highlight={!!content.data.highlight}
  titleShort={content.data.title}
  titleSuffix=" | のなさばどっとねっとブログ"
  description={content.data.short}
  pageType="article"
>
  <Section>
    <Breadcrumb
      variant="underline"
      items={[
        { title: "のなさばどっとねっと", url: "/" },
        { title: "ブログ", url: "/blog" },
        { title: content.data.title },
      ]}
    />
  </Section>
  <Section>
    <ArticleHeading title={content.data.title} mb="4">
      <Text textAlign="right">
        投稿 <Time temporal={postDate} formatOptions={formatOptions} /> / 最終更新
        <Time temporal={updateDate} formatOptions={formatOptions} />
      </Text>
    </ArticleHeading>
    <Content components={MdxComponents} />
  </Section>
  <Section>
    <BlogPostNavigation prevPost={prevPostLink} nextPost={nextPostLink} />
  </Section>

  {
    useDisqus && (
      <>
        <Section>
          <DisqusArea
            baseName={content.id + ".html"}
            originalTitle={content.data.originalTitle || content.data.title}
          />
        </Section>
      </>
    )
  }
</BaseLayout>
